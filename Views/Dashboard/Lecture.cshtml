@model ContractMonthlyClaimSystem.Models.CoordinatorDashboardViewModel

@{
    ViewData["Title"] = "Lecture Dashboard";

}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        
        <h1 class="hero-h1">Welcome back, @Context.Session.GetString("EmployeeName")!</h1>

        <p class="text-muted">
            Today is <span id="currentDate"></span> | Role: @Context.Session.GetString("Role")
        </p>
    </div>

    @{
        var successMsg = TempData["ClaimSuccess"] as string;
        var errorMsg = TempData["ClaimError"] as string;
    }
    @if (!string.IsNullOrEmpty(successMsg) || !string.IsNullOrEmpty(errorMsg))
    {
        <div id="tempToastContainer"></div>

        <style>
            /* Toast container */
            #tempToastContainer {
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 2000;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                max-width: 360px;
            }

            .temp-toast {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: .75rem 1rem;
                border-radius: .5rem;
                box-shadow: 0 6px 18px rgba(0,0,0,0.15);
                color: #fff;
                font-weight: 500;
                opacity: 1;
                transition: opacity 600ms ease, transform 300ms ease;
            }

                .temp-toast.hide {
                    opacity: 0;
                    transform: translateY(-8px);
                }

                .temp-toast .toast-body {
                    flex: 1;
                    margin-right: .5rem;
                    line-height: 1.2;
                    font-size: .95rem;
                }

                .temp-toast .toast-close {
                    cursor: pointer;
                    padding-left: .5rem;
                    color: rgba(255,255,255,0.9);
                    border: none;
                    background: transparent;
                    font-size: 1.1rem;
                    line-height: 1;
                }

                .temp-toast.success {
                    background: linear-gradient(90deg,#28a745,#2ec26b);
                }

                .temp-toast.error {
                    background: linear-gradient(90deg,#dc3545,#ff6b6b);
                }
        </style>

        <script>
            (function () {
                const success = @Html.Raw(Json.Serialize(successMsg ?? ""));
                const error = @Html.Raw(Json.Serialize(errorMsg ?? ""));
                const container = document.getElementById('tempToastContainer');
                if (!container) return;

                function makeToast(message, kind) {
                    const toast = document.createElement('div');
                    toast.className = 'temp-toast ' + (kind === 'success' ? 'success' : 'error');

                    const body = document.createElement('div');
                    body.className = 'toast-body';
                    body.textContent = message;

                    const btn = document.createElement('button');
                    btn.className = 'toast-close';
                    btn.setAttribute('aria-label', 'Close');
                    btn.innerHTML = '&times;';
                    btn.addEventListener('click', () => removeToast(toast));

                    toast.appendChild(body);
                    toast.appendChild(btn);

                    container.appendChild(toast);

                    // Auto-hide after 20 seconds (20000 ms)
                    const hideAfter = 20000;
                    const timer = setTimeout(() => removeToast(toast), hideAfter);

                    // remove function with fade
                    function removeToast(el) {
                        clearTimeout(timer);
                        el.classList.add('hide');
                        setTimeout(() => {
                            if (el && el.parentNode) el.parentNode.removeChild(el);
                        }, 650); // match CSS transition
                    }
                }

                if (success) makeToast(success, 'success');
                if (error) makeToast(error, 'error');
            })();
        </script>
    }

    <!-- Quick Stats -->
    <div class="row g-4 mb-5 text-center">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <i class="bi bi-clipboard-check display-6 text-info"></i>
                    <h5 class="mt-3">Claims Submitted</h5>
                    <h2 class="fw-bold">@ViewBag.TotalClaims</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <i class="bi bi-hourglass-split display-6 text-warning"></i>
                    <h5 class="mt-3">Verified</h5>
                    <h2 class="fw-bold">@ViewBag.VerifiedClaims</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <i class="bi bi-check-circle display-6 text-success"></i>
                    <h5 class="mt-3">Approved</h5>
                    <h2 class="fw-bold">@ViewBag.ApprovedClaims</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <i class="bi bi-x-circle display-6 text-danger"></i>
                    <h5 class="mt-3">Rejected</h5>
                    <h2 class="fw-bold">@ViewBag.RejectedClaims</h2>
                </div>
            </div>
        </div>
    </div>


    <!-- Feature Cards -->
    
    <div class="row g-4 mb-5" id="featureCardsRow">
        <!-- Submit Claim (clickable) -->
        <div class="col-md-4">
            <div id="submitClaimCard" class="card feature-card h-100 text-center clickable-card">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-file-earmark-text display-4 text-primary"></i>
                    <h4 class="mt-3">Submit Claim</h4>
                    <p class="text-muted">Easily create and submit a new monthly work claim.</p>
                </div>
            </div>
        </div>
        <!-- ===== hidden claim form (appears when Submit Claim card is clicked) ===== -->
        <div class="row" id="claimFormSection" style="display: none;">
            <div class="col-12">
                <div class="card bg-dark text-light rounded-4">
                    <div class="card-header">
                        <h5 class="mb-0 text-info">Submit Claim</h5>
                    </div>

                    <div class="d-flex justify-content-center my-5">
                        <div class="card bg-dark text-light shadow-sm" style="max-width: 500px; width: 100%;">
                            <div class="card-body p-4">
                                <h3 class="card-title text-center mb-4" style="color: #0dcaf0;">Submit Claim</h3>


                                <form id="submitClaimForm" asp-controller="Dashboard" asp-action="SubmitClaim" method="post" enctype="multipart/form-data">
                                    @Html.AntiForgeryToken()
                                    <!-- Hours Worked input remains the same but add name attribute -->
                                    <div class="form-floating mb-3">
                                        <input name="hoursWorked" type="number" class="form-control bg-secondary text-light" id="hoursWorked" placeholder="Hours Worked" min="0" step="0.01">
                                        <label for="hoursWorked">Hours Worked</label>
                                    </div>

                                    <!-- Month input - add name attribute -->
                                    <div class="form-floating mb-3">
                                        <input name="workMonth" type="month" class="form-control bg-secondary text-light" id="workMonth" placeholder="Month">
                                        <label for="workMonth">Month</label>
                                    </div>

                                    <!-- File Upload (only change is the name attribute) -->
                                    <div class="mb-3">
                                        <label class="form-label">Supporting Document (PDF)</label>
                                        <input name="supportingDoc" class="form-control bg-secondary text-light" type="file" id="supportingDoc" accept=".pdf" required>
                                    </div>

                                    <!-- rest of the form unchanged -->
                                    <!-- Submit / Cancel Buttons -->
                                    <div class="d-flex justify-content-end mt-4">
                                        <button type="submit" class="btn btn-info">Submit Claim</button>
                                        <button type="button" class="btn btn-outline-light ms-2" id="cancelClaimBtn">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- View Claims Card -->
        <div class="col-md-4">
            <div class="card feature-card h-100 text-center" id="viewClaimsCard">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-list-check display-4 text-primary"></i>
                    <h4 class="mt-3">View Claims</h4>
                    <p class="text-muted">Track the status of your submitted claims.</p>
                </div>
            </div>
        </div>

        <!-- Claims Table (Initially Hidden) -->
        <div class="card bg-dark text-light shadow-sm my-4" style="max-width: 900px; margin:auto; display:none;" id="viewClaimsContainer">
            <div class="card-body">
                <h4 class="card-title text-center mb-4" style="color: #0dcaf0;">My Submitted Claims</h4>

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle text-center">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Hours Worked</th>
                                <th>Status</th>
                                <th>Document</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.Claims == null || !Model.Claims.Any())
                            {
                                <tr>
                                    <td colspan="6" class="text-muted">No claims submitted yet.</td>
                                </tr>
                            }
                            else
                            {
                                foreach (var c in Model.Claims)
                                {
                                    <tr>
                                        <td>@c.ClaimID</td>
                                        <td>@c.ClaimDate.ToString("yyyy-MM")</td>
                                        <td>@c.HoursWorked</td>
                                        <td>
                                            @if (c.IsDeleted)
                                            {
                                                <span class="badge bg-secondary">Deleted</span>
                                            }
                                            else if (c.Status == "Pending")
                                            {
                                                <span class="badge bg-warning">Pending</span>
                                            }
                                            else if (c.Status == "Verified" || c.Status == "Verified")
                                            {
                                                <span class="badge bg-warning">Verified</span>
                                            }

                                            else if (c.Status == "Approved")
                                            {
                                                <span class="badge bg-success">Approved</span>
                                            }
                                            else if (c.Status == "Rejected")
                                            {
                                                <span class="badge bg-danger">Rejected</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@c.Status</span>
                                            }
                                        </td>

                                        <!-- Document column: show first supporting doc (if any) -->
                                        <td>
                                            @if (c.SupportingDocuments != null && c.SupportingDocuments.Any() == true)
                                            {
                                                var doc = c.SupportingDocuments.First();
                                                <a asp-controller="Dashboard" asp-action="DownloadDocument" asp-route-id="@doc.DocumentID" class="btn btn-sm btn-outline-info">View</a>
                                                <div class="small text-muted mt-1">@System.IO.Path.GetFileName(doc.FilePath)</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">No document</span>
                                            }
                                        </td>

                                        <!-- Actions column: edit (modal) + delete (soft) -->
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-warning me-1 edit-claim-btn"
                                                    data-claim-id="@c.ClaimID"
                                                    data-hours="@c.HoursWorked"
                                                    data-month="@c.ClaimDate.ToString("yyyy-MM")"
                                                    data-doc-id="@(c.SupportingDocuments != null && c.SupportingDocuments.Any() ? c.SupportingDocuments.First().DocumentID.ToString() : "")"
                                                    data-doc-name="@(c.SupportingDocuments != null && c.SupportingDocuments.Any() ? System.IO.Path.GetFileName(c.SupportingDocuments.First().FilePath) : "")">
                                                Edit
                                            </button>

                                            <form asp-controller="Dashboard" asp-action="DeleteClaim" method="post" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this claim?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="claimId" value="@c.ClaimID" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Cancel Button -->
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-light" id="cancelViewClaimsBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Edit Claim Modal (includes optional file replacement) -->
        <div class="modal fade" id="editClaimModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Claim</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form id="editClaimForm" asp-controller="Dashboard" asp-action="EditClaim" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div class="modal-body">
                            <input type="hidden" name="ClaimID" id="editClaimID" />

                            <div class="form-floating mb-3">
                                <input name="HoursWorked" id="editHoursWorked" type="number" class="form-control bg-secondary text-light" min="0" step="0.01" />
                                <label for="editHoursWorked">Hours Worked</label>
                            </div>

                            <div class="form-floating mb-3">
                                <input name="WorkMonth" id="editWorkMonth" type="month" class="form-control bg-secondary text-light" />
                                <label for="editWorkMonth">Month</label>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Current supporting document:</label>
                                <div id="currentDocInfo" class="small text-muted mb-2">— none —</div>

                                <label class="form-label">Replace supporting document (optional) — PDF, max 5MB</label>
                                <input name="NewSupportingDoc" id="editSupportingDoc" class="form-control" type="file" accept=".pdf" />
                            </div>

                            <div class="small text-muted">When you save, total will be recalculated using your department hourly rate.</div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-info">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- Analytics (normal card, can be a link) -->
        <!-- Analytics Card -->
        <div class="col-md-4">
            <div class="card feature-card h-100 text-center" id="analyticsCard">
                <div class="card-body">
                    <i class="bi bi-bar-chart-line display-4 text-primary"></i>
                    <h4 class="mt-3">Analytics</h4>
                    <p class="text-muted">View quick reports of your monthly work.</p>
                </div>
            </div>
        </div>

        <!-- Chart Container (Initially Hidden) -->
        <div class="card bg-dark text-light shadow-sm my-4" style="max-width: 800px; margin:auto; display:none;" id="analyticsChartContainer">
            <div class="card-body">
                <h4 class="card-title text-center mb-4" style="color: #0dcaf0;">Quick Reports</h4>
                <canvas id="quickReportsChart" style="width:100%; height:300px;"></canvas>
                <!-- Cancel Button -->
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-light" id="cancelAnalyticsBtn">Close</button>
                </div>
            </div>
        </div>
        
    </div>

    
        
    <!-- Quick Links -->
    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card quick-link-card">
                <div class="card-body">
                    <i class="bi bi-person-circle display-6 text-info"></i>
                    <h5 class="mt-2">Profile Settings</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card quick-link-card">
                <div class="card-body">
                    <i class="bi bi-question-circle display-6 text-info"></i>
                    <h5 class="mt-2">Help Center</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card quick-link-card">
                <div class="card-body">
                    <i class="bi bi-box-arrow-right display-6 text-danger"></i>
                    <h5 class="mt-2"><a asp-area="" asp-controller="Home" asp-action="Login_Register">Log Out</a></h5>
                    
                </div>
            </div>
        </div>
    </div>
</div>

